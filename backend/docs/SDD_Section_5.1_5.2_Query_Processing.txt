================================================================================
                    SYSTEM DESIGN DOCUMENT - SECTION 5
                      DATA FLOW & INTERACTIONS
================================================================================

5.1 USER QUERY PROCESSING FLOW
--------------------------------------------------------------------------------

PURPOSE: Detailed walkthrough of how a user query flows through the entire system

This section traces the complete journey of a user query from the moment it
arrives at the API to when the response is returned to the user.


5.1.1 OVERVIEW OF QUERY PROCESSING
--------------------------------------------------------------------------------

HIGH-LEVEL FLOW:

User Request â†’ Authentication â†’ Chat Router â†’ Agentic RAG â†’ 
Multi-Agent Orchestrator â†’ Specialized Agents â†’ Result Synthesis â†’ 
Database Storage â†’ Response to User

TOTAL LATENCY TARGET: < 5 seconds for most queries

BREAKDOWN BY STAGE:
1. Authentication & Routing: ~100ms
2. RAG Retrieval: ~500ms
3. Agent Execution: ~2-3s (parallel)
4. Synthesis: ~500ms
5. Database Storage: ~200ms


5.1.2 STEP-BY-STEP FLOW: SIMPLE QUERY
--------------------------------------------------------------------------------

EXAMPLE QUERY: "What is a mutual fund?"
Expected Route: Educational Agent (single agent, simple)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: HTTP REQUEST ARRIVAL                                  â”‚
â”‚  Client â†’ FastAPI Server                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/chat/message                                        â”‚
â”‚  Headers:                                                      â”‚
â”‚    Authorization: Bearer <JWT_TOKEN>                           â”‚
â”‚    Content-Type: application/json                              â”‚
â”‚  Body:                                                         â”‚
â”‚    {                                                           â”‚
â”‚      "message": "What is a mutual fund?",                      â”‚
â”‚      "conversation_id": "550e8400-e29b-41d4-a716-446655440000" â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T0 = 0ms                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: AUTHENTICATION MIDDLEWARE                             â”‚
â”‚  Verify JWT Token                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Actions:                                                      â”‚
â”‚  1. Extract token from Authorization header                    â”‚
â”‚  2. Verify token signature                                     â”‚
â”‚  3. Check token expiration                                     â”‚
â”‚  4. Extract user_id from token payload                         â”‚
â”‚                                                                â”‚
â”‚  Result:                                                       â”‚
â”‚    user_id = "123e4567-e89b-12d3-a456-426614174000"            â”‚
â”‚    user_email = "roshan@example.com"                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T1 = 50ms                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: CHAT ROUTER - REQUEST VALIDATION                     â”‚
â”‚  routers/chat.py: chat_message() endpoint                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Validations:                                                  â”‚
â”‚  âœ“ Message not empty                                           â”‚
â”‚  âœ“ Conversation exists and belongs to user                     â”‚
â”‚  âœ“ Message length < 2000 characters                            â”‚
â”‚                                                                â”‚
â”‚  Database Query:                                               â”‚
â”‚    SELECT * FROM conversations                                 â”‚
â”‚    WHERE id = '550e8400...' AND user_id = '123e4567...'        â”‚
â”‚                                                                â”‚
â”‚  Result: Conversation found âœ“                                  â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T2 = 100ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: FETCH USER PROFILE                                   â”‚
â”‚  Get user preferences and experience level                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database Query:                                               â”‚
â”‚    SELECT user_type, risk_tolerance, education_level           â”‚
â”‚    FROM users WHERE id = '123e4567...'                         â”‚
â”‚                                                                â”‚
â”‚  Result:                                                       â”‚
â”‚    {                                                           â”‚
â”‚      "user_type": "beginner",                                  â”‚
â”‚      "risk_tolerance": "moderate",                             â”‚
â”‚      "education_level": "basic"                                â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T3 = 150ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: STORE USER MESSAGE IN DATABASE                       â”‚
â”‚  Save the incoming message                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Generate Embedding:                                           â”‚
â”‚    text = "What is a mutual fund?"                             â”‚
â”‚    embedding_service.generate_embedding(text)                  â”‚
â”‚    â†’ [0.023, -0.154, 0.876, ..., 0.341] (1536-dim)            â”‚
â”‚                                                                â”‚
â”‚  Database INSERT:                                              â”‚
â”‚    INSERT INTO messages (                                      â”‚
â”‚      conversation_id, user_id, role, content, embedding        â”‚
â”‚    ) VALUES (                                                  â”‚
â”‚      '550e8400...', '123e4567...', 'user',                     â”‚
â”‚      'What is a mutual fund?', <embedding_vector>              â”‚
â”‚    )                                                           â”‚
â”‚                                                                â”‚
â”‚  Result: message_id = "abc123..."                              â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T4 = 300ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: AGENTIC RAG - INTENT CLASSIFICATION                  â”‚
â”‚  services/agentic_rag.py: classify_intent()                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input:                                                        â”‚
â”‚    query = "What is a mutual fund?"                            â”‚
â”‚    context = {}  (no previous conversation)                    â”‚
â”‚                                                                â”‚
â”‚  LLM Call (Gemini):                                            â”‚
â”‚    Prompt: "Classify the intent: [query]                       â”‚
â”‚             Options: educational/market_data/portfolio/..."    â”‚
â”‚                                                                â”‚
â”‚  Result:                                                       â”‚
â”‚    {                                                           â”‚
â”‚      "intent": "CONCEPT_EXPLANATION",                          â”‚
â”‚      "confidence": 0.95,                                       â”‚
â”‚      "reasoning": "User asking definition of financial term"   â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T5 = 500ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: AGENTIC RAG - RETRIEVAL PLANNING                     â”‚
â”‚  services/agentic_rag.py: plan_retrieval()                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Based on intent: CONCEPT_EXPLANATION                          â”‚
â”‚                                                                â”‚
â”‚  Plan:                                                         â”‚
â”‚    {                                                           â”‚
â”‚      "sources": ["educational_content", "conversations"],      â”‚
â”‚      "limit": 5,                                               â”‚
â”‚      "rerank": true,                                           â”‚
â”‚      "filters": {"role": "assistant"}                          â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T6 = 520ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: AGENTIC RAG - VECTOR SIMILARITY SEARCH               â”‚
â”‚  Retrieve relevant context from database                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query Embedding:                                              â”‚
â”‚    embedding = generate_embedding("What is a mutual fund?")    â”‚
â”‚    â†’ [0.023, -0.154, 0.876, ..., 0.341]                       â”‚
â”‚                                                                â”‚
â”‚  Vector Search (educational_content):                          â”‚
â”‚    SELECT title, content, embedding <-> :query_emb as dist     â”‚
â”‚    FROM educational_content                                    â”‚
â”‚    ORDER BY dist LIMIT 5                                       â”‚
â”‚                                                                â”‚
â”‚  Results Retrieved:                                            â”‚
â”‚    1. "Mutual Funds - Definition" (dist: 0.08) âœ“              â”‚
â”‚    2. "Types of Mutual Funds" (dist: 0.15) âœ“                  â”‚
â”‚    3. "Mutual Funds vs ETFs" (dist: 0.28) âœ“                   â”‚
â”‚    4. "NAV in Mutual Funds" (dist: 0.35) âœ“                    â”‚
â”‚    5. "SIP Investments" (dist: 0.42) âœ“                         â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T7 = 650ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: ORCHESTRATOR - COMPLEXITY ASSESSMENT                 â”‚
â”‚  agents/orchestrator.py: assess_complexity()                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Analysis:                                                     â”‚
â”‚    - Single intent: educational âœ“                              â”‚
â”‚    - No risk keywords                                          â”‚
â”‚    - No comparison request                                     â”‚
â”‚    - User level: beginner                                      â”‚
â”‚                                                                â”‚
â”‚  Complexity Score:                                             â”‚
â”‚    intents(1) + risk(0) + comparison(0) + user_factor(1) = 1  â”‚
â”‚                                                                â”‚
â”‚  Result: SIMPLE (single agent execution)                       â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T8 = 680ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: ORCHESTRATOR - AGENT SELECTION                      â”‚
â”‚  agents/orchestrator.py: select_agents()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rules Applied:                                                â”‚
â”‚    Intent = CONCEPT_EXPLANATION â†’ Educational Agent            â”‚
â”‚    Complexity = SIMPLE â†’ Single agent only                     â”‚
â”‚                                                                â”‚
â”‚  Selected Agents:                                              â”‚
â”‚    ["educational_agent"]                                       â”‚
â”‚                                                                â”‚
â”‚  Execution Mode: Direct (no orchestration needed)              â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T9 = 700ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 11: EDUCATIONAL AGENT EXECUTION                          â”‚
â”‚  agents/hybrid_core.py: educational_agent()                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input Preparation:                                            â”‚
â”‚    concept = "mutual fund"                                     â”‚
â”‚    user_level = "beginner"                                     â”‚
â”‚    context = [retrieved educational content]                   â”‚
â”‚                                                                â”‚
â”‚  DSPy Signature Call:                                          â”‚
â”‚    EducationalAgentSignature(                                  â”‚
â”‚      concept="mutual fund",                                    â”‚
â”‚      user_level="beginner",                                    â”‚
â”‚      specific_aspect="definition and basics",                  â”‚
â”‚      context=<retrieved_docs>                                  â”‚
â”‚    )                                                           â”‚
â”‚                                                                â”‚
â”‚  LLM Processing (Gemini):                                      â”‚
â”‚    Generate explanation at beginner level                      â”‚
â”‚    Include real-world examples                                 â”‚
â”‚    Add visual metaphors                                        â”‚
â”‚    Suggest related concepts                                    â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T10 = 3200ms (LLM generation takes ~2.5s)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: AGENT OUTPUT FORMATTING                              â”‚
â”‚  Format the agent response                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agent Raw Output:                                             â”‚
â”‚    {                                                           â”‚
â”‚      "explanation": "A mutual fund is...",                     â”‚
â”‚      "examples": [                                             â”‚
â”‚        "HDFC Equity Fund pools money from...",                 â”‚
â”‚        "Like joining friends to buy pizza..."                  â”‚
â”‚      ],                                                        â”‚
â”‚      "key_points": [                                           â”‚
â”‚        "Professional management",                              â”‚
â”‚        "Diversification",                                      â”‚
â”‚        "Small investment amounts"                              â”‚
â”‚      ],                                                        â”‚
â”‚      "related_concepts": [                                     â”‚
â”‚        "SIP (Systematic Investment Plan)",                     â”‚
â”‚        "NAV (Net Asset Value)",                                â”‚
â”‚        "Types of mutual funds"                                 â”‚
â”‚      ]                                                         â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Formatted Response:                                           â”‚
â”‚    "# Understanding Mutual Funds                               â”‚
â”‚                                                                â”‚
â”‚     A mutual fund is a professionally managed investment...    â”‚
â”‚     [Full formatted response with sections]"                   â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T11 = 3300ms                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 13: STORE AI RESPONSE IN DATABASE                       â”‚
â”‚  Save assistant message with metadata                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Generate Response Embedding:                                  â”‚
â”‚    embedding = generate_embedding(response_text)               â”‚
â”‚                                                                â”‚
â”‚  Database INSERT:                                              â”‚
â”‚    INSERT INTO messages (                                      â”‚
â”‚      conversation_id, user_id, role, content,                  â”‚
â”‚      embedding, agent_used, confidence_score,                  â”‚
â”‚      processing_time, model_used                               â”‚
â”‚    ) VALUES (                                                  â”‚
â”‚      '550e8400...', '123e4567...', 'assistant',                â”‚
â”‚      <formatted_response>, <embedding>,                        â”‚
â”‚      'educational_agent', 0.95, 3.3, 'gemini-1.5-flash'        â”‚
â”‚    )                                                           â”‚
â”‚                                                                â”‚
â”‚  Update Conversation:                                          â”‚
â”‚    UPDATE conversations                                        â”‚
â”‚    SET total_messages = total_messages + 2,  (user + AI)       â”‚
â”‚        last_message_at = NOW()                                 â”‚
â”‚    WHERE id = '550e8400...'                                    â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T12 = 3500ms                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 14: HTTP RESPONSE TO CLIENT                              â”‚
â”‚  Return JSON response to user                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Response Body:                                                â”‚
â”‚    {                                                           â”‚
â”‚      "message_id": "def456...",                                â”‚
â”‚      "response": "# Understanding Mutual Funds\n\n...",        â”‚
â”‚      "agent_used": "educational_agent",                        â”‚
â”‚      "confidence": 0.95,                                       â”‚
â”‚      "processing_time": 3.5,                                   â”‚
â”‚      "related_topics": [                                       â”‚
â”‚        "SIP", "NAV", "Types of mutual funds"                   â”‚
â”‚      ],                                                        â”‚
â”‚      "timestamp": "2025-10-30T10:30:15Z"                       â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  HTTP Status: 200 OK                                           â”‚
â”‚  Content-Type: application/json                                â”‚
â”‚                                                                â”‚
â”‚  TOTAL TIME: 3.5 seconds âœ“                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PERFORMANCE BREAKDOWN:

Stage                           | Time      | Percentage
--------------------------------|-----------|------------
Authentication & Validation     | 150ms     | 4%
User Profile & Message Storage  | 150ms     | 4%
RAG Intent & Retrieval         | 350ms     | 10%
Orchestrator (Complexity)      | 50ms      | 1%
Educational Agent (LLM)        | 2500ms    | 71%
Response Storage               | 200ms     | 6%
Response Formatting            | 100ms     | 3%
--------------------------------|-----------|------------
TOTAL                          | 3500ms    | 100%

BOTTLENECK: LLM generation (71% of time)
OPTIMIZATION: Could cache common queries to reduce LLM calls


5.1.3 STEP-BY-STEP FLOW: COMPLEX QUERY
--------------------------------------------------------------------------------

EXAMPLE QUERY: "Should I invest in Apple stock?"
Expected Route: Market Data Agent + Portfolio Builder (multi-agent, parallel)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEPS 1-7: Same as Simple Query                               â”‚
â”‚  (Authentication, Validation, RAG Intent, Retrieval Planning)   â”‚
â”‚                                                                â”‚
â”‚  Time: T0 to T7 = 650ms                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: INTENT CLASSIFICATION                                 â”‚
â”‚  Different from simple query                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query: "Should I invest in Apple stock?"                      â”‚
â”‚                                                                â”‚
â”‚  LLM Classification:                                           â”‚
â”‚    Primary Intent: PERSONALIZED_ADVICE                         â”‚
â”‚    Secondary Intents:                                          â”‚
â”‚      - MARKET_DATA (need Apple stock info)                     â”‚
â”‚      - PORTFOLIO_BUILDING (investment recommendation)          â”‚
â”‚                                                                â”‚
â”‚  Result:                                                       â”‚
â”‚    {                                                           â”‚
â”‚      "intent": "PERSONALIZED_ADVICE",                          â”‚
â”‚      "sub_intents": ["market_data", "portfolio"],              â”‚
â”‚      "confidence": 0.85                                        â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T8 = 700ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: COMPLEXITY ASSESSMENT                                 â”‚
â”‚  Higher complexity than simple query                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Analysis:                                                     â”‚
â”‚    - Multiple intents: market_data + portfolio â†’ +2            â”‚
â”‚    - Investment decision: "should I invest" â†’ +2               â”‚
â”‚    - User level: beginner â†’ +1                                 â”‚
â”‚                                                                â”‚
â”‚  Complexity Score: 5                                           â”‚
â”‚                                                                â”‚
â”‚  Result: COMPLEX (multi-agent, parallel execution)             â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T9 = 720ms                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: AGENT SELECTION                                      â”‚
â”‚  Multiple agents needed                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rules Applied:                                                â”‚
â”‚    1. Market data intent â†’ Market Data Agent                   â”‚
â”‚    2. Portfolio advice intent â†’ Portfolio Builder              â”‚
â”‚    3. Beginner user â†’ Educational Agent (explain risks)        â”‚
â”‚                                                                â”‚
â”‚  Selected Agents:                                              â”‚
â”‚    [                                                           â”‚
â”‚      "market_data_agent:AAPL",                                 â”‚
â”‚      "portfolio_builder",                                      â”‚
â”‚      "educational_agent"                                       â”‚
â”‚    ]                                                           â”‚
â”‚                                                                â”‚
â”‚  Execution Mode: PARALLEL (all agents run simultaneously)      â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T10 = 750ms                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 11: PARALLEL AGENT EXECUTION                             â”‚
â”‚  Three agents execute at the same time using asyncio.gather()  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT 1: Market Data Agent (AAPL)                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 1. Fetch Apple stock data from Yahoo Finance            â”‚  â”‚
â”‚  â”‚    - Price: $150.25                                     â”‚  â”‚
â”‚  â”‚    - P/E Ratio: 28.5                                    â”‚  â”‚
â”‚  â”‚    - Market Cap: $2.5T                                  â”‚  â”‚
â”‚  â”‚    - 52-week range: $140-180                            â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ 2. Calculate technical indicators                       â”‚  â”‚
â”‚  â”‚    - RSI: 62 (neutral)                                  â”‚  â”‚
â”‚  â”‚    - SMA200: $145 (price above trend)                   â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ 3. Generate interpretation                              â”‚  â”‚
â”‚  â”‚    "Apple trading at $150, fairly valued..."            â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ Time: 2.0 seconds                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT 2: Portfolio Builder                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 1. Fetch user risk profile                              â”‚  â”‚
â”‚  â”‚    - Risk tolerance: moderate                           â”‚  â”‚
â”‚  â”‚    - No existing portfolio                              â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ 2. Generate recommendation                              â”‚  â”‚
â”‚  â”‚    "For moderate risk, consider 10-15% allocation"      â”‚  â”‚
â”‚  â”‚    "Don't put all eggs in one basket"                   â”‚  â”‚
â”‚  â”‚    "Build diversified portfolio first"                  â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ Time: 2.5 seconds                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT 3: Educational Agent                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 1. Explain investment basics for beginner               â”‚  â”‚
â”‚  â”‚    "What is diversification?"                           â”‚  â”‚
â”‚  â”‚    "Why not invest in single stock?"                    â”‚  â”‚
â”‚  â”‚    "Understanding risk vs reward"                       â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚ Time: 2.2 seconds                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  PARALLEL EXECUTION WITH asyncio.gather():                     â”‚
â”‚    Total Time = max(2.0s, 2.5s, 2.2s) = 2.5 seconds           â”‚
â”‚    (NOT 2.0 + 2.5 + 2.2 = 6.7 seconds!)                        â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T11 = 750ms + 2500ms = 3250ms                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: RESULT SYNTHESIS                                     â”‚
â”‚  Combine three agent outputs into coherent response            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input to Synthesizer:                                         â”‚
â”‚    {                                                           â”‚
â”‚      "market_data": {                                          â”‚
â”‚        "symbol": "AAPL",                                       â”‚
â”‚        "price": 150.25,                                        â”‚
â”‚        "pe_ratio": 28.5,                                       â”‚
â”‚        "interpretation": "Fairly valued, neutral momentum"     â”‚
â”‚      },                                                        â”‚
â”‚      "portfolio": {                                            â”‚
â”‚        "recommendation": "10-15% allocation max",              â”‚
â”‚        "reasoning": "Diversification important for beginners"  â”‚
â”‚      },                                                        â”‚
â”‚      "education": {                                            â”‚
â”‚        "key_concepts": ["diversification", "risk management"]  â”‚
â”‚      }                                                         â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚  Synthesis LLM Call:                                           â”‚
â”‚    "Combine these expert insights into beginner-friendly       â”‚
â”‚     response that:                                             â”‚
â”‚     1. Answers 'should I invest in Apple?'                     â”‚
â”‚     2. Uses market data to support answer                      â”‚
â”‚     3. Explains diversification concept                        â”‚
â”‚     4. Provides actionable recommendation"                     â”‚
â”‚                                                                â”‚
â”‚  Synthesized Response:                                         â”‚
â”‚    "# Should You Invest in Apple Stock?                        â”‚
â”‚                                                                â”‚
â”‚     ## Current Market Analysis                                 â”‚
â”‚     Apple is trading at $150.25 with P/E of 28.5...            â”‚
â”‚                                                                â”‚
â”‚     ## Key Considerations                                      â”‚
â”‚     As a beginner, diversification is crucial...               â”‚
â”‚                                                                â”‚
â”‚     ## Recommendation                                          â”‚
â”‚     Yes, but limit to 10-15% of portfolio..."                  â”‚
â”‚                                                                â”‚
â”‚  Timestamp: T12 = 3750ms                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 13-14: Store Response & Return to User                   â”‚
â”‚  Same as simple query                                          â”‚
â”‚                                                                â”‚
â”‚  TOTAL TIME: 4.0 seconds âœ“                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PERFORMANCE COMPARISON:

                        Simple Query    Complex Query
---------------------------------------------------------
RAG & Planning          350ms           400ms
Agent Execution         2500ms          2500ms (parallel!)
Synthesis               100ms           500ms
Total                   3.5s            4.0s

KEY INSIGHT: Parallel execution prevents time multiplication!
Sequential would be: 2.0s + 2.5s + 2.2s = 6.7 seconds
Parallel is: max(2.0s, 2.5s, 2.2s) = 2.5 seconds
SPEEDUP: 2.7x faster! ğŸš€


--- DIAGRAM 5.1: COMPLETE QUERY PROCESSING FLOW ---

[MERMAID CODE - Copy this to Mermaid Live Editor]

sequenceDiagram
    participant User
    participant FastAPI
    participant Auth
    participant ChatRouter
    participant RAG
    participant Orchestrator
    participant Agent1
    participant Agent2
    participant Agent3
    participant DB
    participant YahooAPI
    participant GeminiAPI
    
    User->>FastAPI: POST /api/chat/message
    FastAPI->>Auth: Verify JWT Token
    Auth-->>FastAPI: user_id
    
    FastAPI->>ChatRouter: Route to chat endpoint
    ChatRouter->>DB: Fetch user profile
    DB-->>ChatRouter: user_type, risk_tolerance
    
    ChatRouter->>DB: Store user message
    DB-->>ChatRouter: message_id
    
    ChatRouter->>RAG: Classify intent
    RAG->>GeminiAPI: LLM classification
    GeminiAPI-->>RAG: intent + confidence
    
    RAG->>DB: Vector similarity search
    DB-->>RAG: Retrieved context
    
    RAG-->>ChatRouter: Intent + Context
    
    ChatRouter->>Orchestrator: Process query
    Orchestrator->>Orchestrator: Assess complexity
    Orchestrator->>Orchestrator: Select agents
    
    par Parallel Agent Execution
        Orchestrator->>Agent1: Execute (Market Data)
        Agent1->>YahooAPI: Fetch stock data
        YahooAPI-->>Agent1: Stock info
        Agent1-->>Orchestrator: Market analysis
        
        Orchestrator->>Agent2: Execute (Portfolio)
        Agent2->>GeminiAPI: Generate recommendation
        GeminiAPI-->>Agent2: Portfolio advice
        Agent2-->>Orchestrator: Recommendations
        
        Orchestrator->>Agent3: Execute (Educational)
        Agent3->>GeminiAPI: Generate explanation
        GeminiAPI-->>Agent3: Educational content
        Agent3-->>Orchestrator: Explanation
    end
    
    Orchestrator->>Orchestrator: Synthesize results
    Orchestrator->>GeminiAPI: Synthesis LLM call
    GeminiAPI-->>Orchestrator: Final response
    
    Orchestrator-->>ChatRouter: Synthesized response
    
    ChatRouter->>DB: Store AI response
    DB-->>ChatRouter: response_id
    
    ChatRouter-->>FastAPI: JSON response
    FastAPI-->>User: HTTP 200 with answer

[END MERMAID CODE]


================================================================================

5.2 MULTI-AGENT EXECUTION FLOW
--------------------------------------------------------------------------------

PURPOSE: Detailed look at how the orchestrator coordinates multiple agents

This section focuses specifically on the orchestrator's internal workings
when handling complex queries requiring multiple agents.


5.2.1 ORCHESTRATION MODES
--------------------------------------------------------------------------------

The orchestrator supports THREE execution modes based on agent dependencies:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MODE 1: DIRECT (Single Agent)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  When: Simple query, single intent                     â”‚
â”‚  Flow: Query â†’ Agent â†’ Response                        â”‚
â”‚  Latency: Minimal overhead                             â”‚
â”‚                                                        â”‚
â”‚  Example: "What is a stock?"                           â”‚
â”‚  â†’ Educational Agent only                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MODE 2: SEQUENTIAL (Dependent Agents)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  When: Agent B needs output from Agent A               â”‚
â”‚  Flow: Query â†’ Agent A â†’ Output A â†’ Agent B â†’ Response â”‚
â”‚  Latency: Additive (A + B)                             â”‚
â”‚                                                        â”‚
â”‚  Example: "Explain P/E ratio and show me Apple's"      â”‚
â”‚  â†’ Market Data Agent (get Apple P/E)                   â”‚
â”‚  â†’ Educational Agent (explain using actual number)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MODE 3: PARALLEL (Independent Agents)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  When: Agents can work independently                   â”‚
â”‚  Flow: Query â†’ [Agent A || Agent B || Agent C]         â”‚
â”‚         â†’ Synthesize â†’ Response                        â”‚
â”‚  Latency: max(A, B, C) - fastest mode!                 â”‚
â”‚                                                        â”‚
â”‚  Example: "Should I invest in tech stocks?"            â”‚
â”‚  â†’ Market Agent || Portfolio Agent || Educational      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


5.2.2 DEPENDENCY DETECTION
--------------------------------------------------------------------------------

How does the orchestrator know if agents are dependent or independent?

DECISION TREE:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check 1: Do agents need same input?                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  If YES â†’ Can run in PARALLEL                       â”‚
â”‚  If NO â†’ Need to check dependencies                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check 2: Does Agent B reference Agent A's output?  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  If YES â†’ Must run SEQUENTIAL (A then B)            â”‚
â”‚  If NO â†’ Can run in PARALLEL                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check 3: Any explicit ordering requirement?        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  If YES â†’ Run in specified order (SEQUENTIAL)       â”‚
â”‚  If NO â†’ Default to PARALLEL for speed              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


EXAMPLES:

Query: "Compare Apple vs Microsoft"
Analysis:
  - Agent A: Market Data (AAPL)
  - Agent B: Market Data (MSFT)
  - Dependencies: NONE (both fetch different stocks)
  - Decision: PARALLEL âœ“

Query: "Fetch Tesla price and explain if it's good"
Analysis:
  - Agent A: Market Data (TSLA)
  - Agent B: Educational (explain P/E ratio)
  - Dependencies: B needs A's P/E number to explain
  - Decision: SEQUENTIAL (A â†’ B) âœ“

Query: "Should I invest $10,000 in SBI Bank?"
Analysis:
  - Agent A: Market Data (SBIN.NS)
  - Agent B: Portfolio Builder (recommendation)
  - Agent C: Educational (explain diversification)
  - Dependencies: NONE (all use same query)
  - Decision: PARALLEL âœ“


5.2.3 PARALLEL EXECUTION INTERNALS
--------------------------------------------------------------------------------

IMPLEMENTATION USING ASYNCIO:

class MultiAgentOrchestrator:
    async def execute_parallel(
        self, 
        agents: list[str], 
        user_query: str, 
        context: dict
    ) -> list[dict]:
        """Execute multiple agents in parallel"""
        
        # Step 1: Create async tasks for each agent
        tasks = []
        for agent_name in agents:
            task = self._create_agent_task(agent_name, user_query, context)
            tasks.append(task)
        
        # Step 2: Execute all tasks concurrently
        start_time = time.time()
        results = await asyncio.gather(*tasks, return_exceptions=True)
        total_time = time.time() - start_time
        
        # Step 3: Process results and handle errors
        processed_results = []
        for i, result in enumerate(results):
            if isinstance(result, Exception):
                # Agent failed, log error but continue
                logger.error(f"Agent {agents[i]} failed: {result}")
                processed_results.append({
                    "agent": agents[i],
                    "success": False,
                    "error": str(result)
                })
            else:
                processed_results.append({
                    "agent": agents[i],
                    "success": True,
                    "result": result,
                    "execution_time": result.get("_execution_time", 0)
                })
        
        logger.info(f"Parallel execution completed in {total_time:.2f}s")
        return processed_results
    
    async def _create_agent_task(
        self, 
        agent_name: str, 
        user_query: str, 
        context: dict
    ):
        """Create async task for single agent"""
        
        start_time = time.time()
        
        try:
            if agent_name == "educational_agent":
                result = await self.hybrid_system.educational_agent(
                    user_query, context
                )
            elif agent_name == "market_data_agent":
                result = await self.hybrid_system.market_data_agent(
                    user_query, context
                )
            elif agent_name == "portfolio_builder":
                result = await self.hybrid_system.portfolio_builder(
                    user_query, context
                )
            elif agent_name.startswith("market_data_agent:"):
                # Special case: market data for specific stock
                symbol = agent_name.split(":")[1]
                result = await self.hybrid_system.market_data_agent(
                    symbol, context
                )
            else:
                raise ValueError(f"Unknown agent: {agent_name}")
            
            # Add execution time to result
            result["_execution_time"] = time.time() - start_time
            return result
            
        except Exception as e:
            logger.error(f"Error executing {agent_name}: {e}")
            raise


EXECUTION TIMELINE EXAMPLE:

Query: "Should I invest in Apple stock?"
Agents: [market_data_agent:AAPL, portfolio_builder, educational_agent]

Timeline (milliseconds):
0ms     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Orchestrator starts parallel execution          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Market Data Agent: AAPL       â”‚
        â”‚ - Fetch from Yahoo Finance    â”‚
100ms   â”‚ - Calculate indicators        â”‚
        â”‚ - Generate interpretation     â”‚
2000ms  â”‚ âœ“ Complete                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Portfolio Builder Agent               â”‚
        â”‚ - Fetch user profile                  â”‚
200ms   â”‚ - Generate recommendation             â”‚
        â”‚ - Calculate allocation                â”‚
2500ms  â”‚ âœ“ Complete (slowest)                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Educational Agent               â”‚
        â”‚ - Retrieve concepts             â”‚
150ms   â”‚ - Generate explanation          â”‚
2200ms  â”‚ âœ“ Complete                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2500ms  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ All agents complete (waited for slowest)        â”‚
        â”‚ Total time: 2.5s (NOT 2.0 + 2.5 + 2.2 = 6.7s!) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


5.2.4 ERROR HANDLING IN MULTI-AGENT EXECUTION
--------------------------------------------------------------------------------

What happens if one agent fails?

STRATEGY: Graceful Degradation

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scenario 1: Non-Critical Agent Fails                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agents: [Market Data, Portfolio, Educational]         â”‚
â”‚  Failure: Educational Agent times out                  â”‚
â”‚                                                        â”‚
â”‚  Action:                                               â”‚
â”‚  âœ“ Continue with Market Data + Portfolio results       â”‚
â”‚  âœ“ Log error for monitoring                            â”‚
â”‚  âœ“ Inform user: "Note: Educational explanation         â”‚
â”‚    unavailable, showing market analysis only"          â”‚
â”‚                                                        â”‚
â”‚  User still gets useful response! âœ“                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scenario 2: Critical Agent Fails                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query: "What is Apple's stock price?"                 â”‚
â”‚  Agents: [Market Data] (only agent)                    â”‚
â”‚  Failure: Market Data Agent fails (API down)           â”‚
â”‚                                                        â”‚
â”‚  Action:                                               â”‚
â”‚  âœ— Cannot provide meaningful response                  â”‚
â”‚  âœ“ Return error message to user                        â”‚
â”‚  âœ“ Suggest retry or alternative query                  â”‚
â”‚                                                        â”‚
â”‚  Error Response:                                       â”‚
â”‚  "I'm having trouble fetching market data right now.   â”‚
â”‚   Please try again in a moment. In the meantime,       â”‚
â”‚   I can explain what stock prices represent if         â”‚
â”‚   you'd like!"                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scenario 3: Multiple Agents Fail                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agents: [Market Data, Portfolio, Educational]         â”‚
â”‚  Failure: 2 out of 3 agents fail                       â”‚
â”‚                                                        â”‚
â”‚  Action:                                               â”‚
â”‚  If success_rate < 50%:                                â”‚
â”‚    âœ— Return error (insufficient information)           â”‚
â”‚  Else:                                                 â”‚
â”‚    âœ“ Continue with partial results                     â”‚
â”‚    âœ“ Add disclaimer about incomplete information       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


IMPLEMENTATION:

async def handle_agent_results(
    self, 
    results: list[dict], 
    required_agents: list[str]
) -> dict:
    """Handle agent execution results with error tolerance"""
    
    # Count successes and failures
    successes = [r for r in results if r["success"]]
    failures = [r for r in results if not r["success"]]
    
    success_rate = len(successes) / len(results)
    
    # Check if critical agents succeeded
    critical_agents_ok = all(
        agent in [r["agent"] for r in successes]
        for agent in required_agents
    )
    
    if not critical_agents_ok:
        # Critical agent failed
        return {
            "status": "error",
            "message": "Unable to process query due to service unavailability",
            "failed_agents": [f["agent"] for f in failures],
            "suggestion": "Please try again in a moment"
        }
    
    elif success_rate < 0.5:
        # More than half failed
        return {
            "status": "error",
            "message": "Multiple services unavailable, cannot provide reliable answer",
            "failed_agents": [f["agent"] for f in failures]
        }
    
    else:
        # Enough succeeded, continue with partial results
        return {
            "status": "partial_success",
            "results": successes,
            "warnings": [
                f"Note: {f['agent']} unavailable - response may be incomplete"
                for f in failures
            ]
        }


5.2.5 RESULT AGGREGATION PATTERNS
--------------------------------------------------------------------------------

How are multiple agent outputs combined?

PATTERN 1: CONCATENATION (Simple)
  Used when: Agents provide independent insights
  Method: Stack responses in logical order
  
  Example:
    Market Data output: "Apple trading at $150..."
    + Educational output: "Diversification means..."
    + Portfolio output: "Recommendation: 10-15% allocation"
    = Combined: Three separate sections

PATTERN 2: SYNTHESIS (Advanced)
  Used when: Agents provide overlapping insights
  Method: LLM combines into coherent narrative
  
  Example:
    Market Data: "P/E is 28.5"
    Educational: "P/E ratio measures valuation"
    â†’ Synthesized: "Apple's P/E of 28.5 means investors 
                    pay $28.50 for each $1 of earnings,
                    indicating moderate expectations..."

PATTERN 3: PRIORITIZATION (Conflict)
  Used when: Agents contradict each other
  Method: Present both views + explain nuance
  
  Example:
    Market Data: "Stock overvalued (P/E high)"
    Portfolio: "Good for growth portfolio"
    â†’ Resolved: "While expensive by traditional metrics,
                 fits growth strategy if you accept risk"

PATTERN 4: VOTING (Multiple Similar Agents)
  Used when: Multiple agents same type (future)
  Method: Majority vote or confidence-weighted average
  
  Example:
    Agent A: "Buy" (confidence 0.8)
    Agent B: "Buy" (confidence 0.9)
    Agent C: "Hold" (confidence 0.6)
    â†’ Decision: "Buy" (2 votes, higher confidence)


--- DIAGRAM 5.2: MULTI-AGENT EXECUTION FLOW ---

[MERMAID CODE - Copy this to Mermaid Live Editor]

graph TD
    START[Complex Query Arrives] --> ANALYZE[Analyze Query]
    
    ANALYZE --> DETECT[Detect Agent Dependencies]
    
    DETECT --> DEP{Dependencies?}
    
    DEP -->|None| PARALLEL[Parallel Execution Mode]
    DEP -->|Sequential| SEQUENCE[Sequential Execution Mode]
    DEP -->|Mixed| HYBRID[Hybrid Execution Mode]
    
    PARALLEL --> CREATE_TASKS[Create Async Tasks]
    CREATE_TASKS --> GATHER[asyncio.gather]
    
    GATHER --> AGENT_A[Agent A]
    GATHER --> AGENT_B[Agent B]
    GATHER --> AGENT_C[Agent C]
    
    AGENT_A --> WAIT[Wait for All]
    AGENT_B --> WAIT
    AGENT_C --> WAIT
    
    SEQUENCE --> RUN_A[Run Agent A]
    RUN_A --> PASS[Pass Output]
    PASS --> RUN_B[Run Agent B]
    RUN_B --> DONE_SEQ[Sequential Complete]
    
    WAIT --> CHECK{All Succeeded?}
    DONE_SEQ --> CHECK
    
    CHECK -->|Yes| AGGREGATE[Aggregate Results]
    CHECK -->|Partial| PARTIAL[Graceful Degradation]
    CHECK -->|Critical Fail| ERROR[Return Error]
    
    AGGREGATE --> SYNTH_MODE{Synthesis Mode?}
    
    SYNTH_MODE -->|Concatenate| CONCAT[Stack Responses]
    SYNTH_MODE -->|Synthesize| LLM_SYNTH[LLM Synthesis]
    SYNTH_MODE -->|Prioritize| RESOLVE[Resolve Conflicts]
    
    CONCAT --> FINAL[Final Response]
    LLM_SYNTH --> FINAL
    RESOLVE --> FINAL
    
    PARTIAL --> WARN[Add Warnings]
    WARN --> FINAL
    
    ERROR --> USER_ERROR[Error Message to User]
    
    FINAL --> RETURN[Return to User]
    USER_ERROR --> RETURN
    
    style PARALLEL fill:#4ECDC4
    style SEQUENCE fill:#F7DC6F
    style CHECK fill:#FF6B6B
    style LLM_SYNTH fill:#BB8FCE
    style FINAL fill:#2ECC71

[END MERMAID CODE]


================================================================================

SUMMARY: SECTIONS 5.1 & 5.2
================================================================================

5.1 USER QUERY PROCESSING FLOW
- Complete end-to-end flow (14 steps)
- Simple query example (3.5s total)
- Complex query example (4.0s total)
- Performance breakdowns and bottleneck analysis
- Sequence diagram showing all interactions

5.2 MULTI-AGENT EXECUTION FLOW
- Three orchestration modes (Direct/Sequential/Parallel)
- Dependency detection algorithm
- Parallel execution with asyncio.gather()
- Error handling and graceful degradation
- Result aggregation patterns (4 types)
- Execution timeline visualization

================================================================================

NEXT: Sections 5.3 & 5.4
- 5.3: RAG Retrieval Flow
- 5.4: Database Interaction Flow

These will complete Section 5 (Data Flow & Interactions).
Ready to continue?
